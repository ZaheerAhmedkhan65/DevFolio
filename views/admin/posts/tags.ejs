<div class="max-w-4xl mx-auto p-6">

    <h1 class="text-3xl font-bold mb-6 text-gray-800">Post Tags</h1>

    <!-- Create New Tag -->
    <div class="bg-white p-4 rounded-xl shadow mb-6">
        <h2 class="text-xl font-semibold mb-3">Create New Tag</h2>
        <form id="createTagForm" class="flex gap-3">
            <input type="text" name="name" placeholder="Tag Name" class="w-1/2 p-2 border rounded-md" required />
            <input type="text" name="slug" placeholder="Slug" class="w-1/2 p-2 border rounded-md" required />
            <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md">
                Add
            </button>
        </form>
    </div>

    <!-- Tags Table -->
    <div class="bg-white p-6 rounded-xl shadow">
        <table class="w-full border-collapse">
            <thead>
                <tr class="bg-gray-200 text-left">
                    <th class="p-3">Name</th>
                    <th class="p-3">Slug</th>
                    <th class="p-3">Actions</th>
                </tr>
            </thead>
            <tbody>
                <% tags.forEach(tag=> { %>
                    <tr id="row-<%= tag.id %>" class="border-t">
                        <td class="p-3 font-semibold text-gray-800" id="name-<%= tag.id %>">
                            <%= tag.name %>
                        </td>
                        <td class="p-3 text-gray-600" id="slug-<%= tag.id %>">
                            <%= tag.slug %>
                        </td>
                        <td class="p-3 flex gap-2">
                            <button onclick="editTag(<%= tag.id %>)"
                                class="px-3 py-1 bg-yellow-500 hover:bg-yellow-600 text-white rounded-md">
                                Edit
                            </button>
                            <button onclick="deleteTag(<%= tag.id %>)"
                                class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded-md">
                                Delete
                            </button>
                        </td>
                    </tr>
                    <% }) %>
            </tbody>
        </table>
    </div>
</div>

<!-- Inline Edit JS -->
<script>
    async function editTag(id) {
        const nameCell = document.getElementById("name-" + id);
        const slugCell = document.getElementById("slug-" + id);
        const row = document.getElementById("row-" + id);

        const currentName = nameCell.innerText;
        const currentSlug = slugCell.innerText;

        row.innerHTML = `
        <td class="p-3">
          <input id="edit-name-${id}" value="${currentName}"
            class="p-2 border rounded-md w-full" />
        </td>
        <td class="p-3">
          <input id="edit-slug-${id}" value="${currentSlug}"
            class="p-2 border rounded-md w-full" />
        </td>
        <td class="p-3 flex gap-2">
          <button onclick="saveTag(${id})"
            class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded-md">Save</button>

          <button onclick="cancelEdit(${id}, '${currentName}', '${currentSlug}')"
            class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white rounded-md">Cancel</button>
        </td>
      `;
    }

    function cancelEdit(id, name, slug) {
        const row = document.getElementById("row-" + id);
        row.innerHTML = `
        <td class="p-3 font-semibold text-gray-800" id="name-${id}">${name}</td>
        <td class="p-3 text-gray-600" id="slug-${id}">${slug}</td>
        <td class="p-3 flex gap-2">
          <button onclick="editTag(${id})"
            class="px-3 py-1 bg-yellow-500 hover:bg-yellow-600 text-white rounded-md">Edit</button>
          <button onclick="deleteTag(${id})"
            class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded-md">Delete</button>
        </td>`;
    }

    async function saveTag(id) {
        const newName = document.getElementById("edit-name-" + id).value;
        const newSlug = document.getElementById("edit-slug-" + id).value;

        const res = await fetch(`/admin/post_tags/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: newName, slug: newSlug })
        });

        const data = await res.json();

        if (data.error) return alert(data.error);

        // Reload to update UI cleanly
        location.reload();
    }

    async function deleteTag(id) {
        if (!confirm("Delete this tag?")) return;

        const res = await fetch(`/admin/post_tags/${id}`, { method: "DELETE" });

        location.reload();
    }

    // Create Tag
    const createForm = document.getElementById("createTagForm");

    createForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = new FormData(createForm);
        const name = formData.get("name");
        const slug = formData.get("slug");

        const res = await fetch("/admin/post_tags", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, slug })
        });

        location.reload();
    });
</script>