<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/trix/2.0.0/trix.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/trix/2.0.0/trix.umd.min.js"></script>

<div class="p-6 max-w-4xl mx-auto">

    <h1 class="text-3xl font-bold mb-6"><%= title %></h1>

    <form id="createPostForm" action="/posts/create" method="POST">

        <!-- TITLE -->
        <div class="mb-4">
            <label class="block font-semibold">Title</label>
            <input type="text" name="title"
                   class="w-full p-2 border rounded-lg"
                   value="<%= post?.title || '' %>" required>
        </div>

        <!-- CONTENT -->
        <div class="mb-4">
            <label class="block font-semibold">Content</label>

            <input id="content" type="hidden" name="content" value="<%= post?.content || '' %>">
            <trix-editor input="content" class="trix-content h-60 bg-white shadow p-3 rounded-lg"></trix-editor>
        </div>

        <!-- EXCERPT -->
        <div class="mb-4">
            <label class="block font-semibold">Excerpt (optional)</label>
            <textarea name="excerpt"
                class="w-full p-2 border rounded-lg"
                placeholder="Short summary..."><%= post?.excerpt || '' %></textarea>
        </div>

        <!-- FEATURED IMAGE UPLOAD -->
        <div class="mb-4">
            <label class="block font-semibold">Featured Image</label>
            <input type="file" id="upload-image" class="w-full p-2 border rounded-lg">

            <input type="hidden" name="featured_image_url" id="featured_image_url"
                   value="<%= post?.featured_image_url || '' %>">

            <div id="image-preview" class="mt-3">
                <% if (post?.featured_image_url) { %>
                    <img src="<%= post.featured_image_url %>" class="w-48 rounded shadow">
                <% } %>
            </div>
        </div>

        <!-- CATEGORIES -->
        <div class="mb-4">
            <label class="block font-semibold">Categories</label>
            <select name="category_ids" multiple
                class="w-full p-2 border rounded-lg h-32">
                <% categories.forEach(c => { %>
                    <option value="<%= c.id %>"><%= c.name %></option>
                <% }) %>
            </select>
            <p class="text-sm text-gray-500">Hold Ctrl (Windows) or Cmd (Mac) to select multiple</p>
        </div>

        <!-- TAGS -->
        <div class="mb-4">
            <label class="block font-semibold">Tags</label>
            <select name="tag_ids" multiple
                class="w-full p-2 border rounded-lg h-32">
                <% tags.forEach(t => { %>
                    <option value="<%= t.id %>"><%= t.name %></option>
                <% }) %>
            </select>
        </div>

        <!-- STATUS -->
        <div class="mb-4">
            <label class="block font-semibold">Post Status</label>
            <select name="status" class="w-full p-2 border rounded-lg">
                <option value="draft">Draft</option>
                <option value="published">Published</option>
            </select>
        </div>

        <!-- IS FEATURED -->
        <div class="mb-4 flex items-center gap-3">
            <input type="checkbox" name="is_featured" value="true"
                   class="w-5 h-5" <%= post?.is_featured ? "checked" : "" %> >
            <label class="font-semibold">Mark as Featured</label>
        </div>

        <!-- READ TIME -->
        <div class="mb-4">
            <label class="block font-semibold">Estimated Read Time (minutes)</label>
            <input type="number" name="read_time"
                   class="w-full p-2 border rounded-lg"
                   min="1" value="<%= post?.read_time || 5 %>">
        </div>

        <!-- SUBMIT BUTTON -->
        <button type="submit"
                class="px-4 py-2 bg-blue-600 text-white rounded-lg w-full">
            Save Post
        </button>
    </form>
</div>

<script>
/* IMAGE UPLOAD HANDLER */
document.getElementById("upload-image").addEventListener("change", async function () {
    const file = this.files[0];
    if (!file) return;

    const form = new FormData();
    form.append("image", file);

    const res = await fetch("/upload/post-image", {
        method: "POST",
        body: form
    });

    const data = await res.json();

    if (data.url) {
        document.getElementById("featured_image_url").value = data.url;
        document.getElementById("image-preview").innerHTML =
            `<img src="${data.url}" class="w-48 rounded shadow">`;
    }
});
</script>
